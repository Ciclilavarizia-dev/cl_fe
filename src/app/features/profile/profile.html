<div class="container py-4" *ngIf="!loading; else loadingTemplate">
  <div *ngIf="profile; else noProfile">
    <div class="row profile-container">
      <!-- Sidebar -->
      <div class="col-12 col-md-3 sidebar-box">
        <div class="nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
          <button
            class="nav-link active"
            data-bs-toggle="pill"
            data-bs-target="#tab-info"
            type="button"
            role="tab"
          >
            Informazioni Personali
          </button>

          <button
            class="nav-link"
            data-bs-toggle="pill"
            data-bs-target="#tab-address"
            type="button"
            role="tab"
          >
            Indirizzi
          </button>

          <button
            class="nav-link"
            data-bs-toggle="pill"
            data-bs-target="#tab-orders"
            type="button"
            role="tab"
          >
            Ordini
          </button>
        </div>
      </div>

      <!-- Contenuto -->
      <div class="col-12 col-md-9">
        <div class="tab-content">
          <!-- TAB 1: Info -->
          <div class="tab-pane fade show active" id="tab-info" role="tabpanel">
            <h3>Dati Personali</h3>

            <p><strong>Nome:</strong> {{ profile.firstName }} {{ profile.lastName }}</p>
            <p><strong>Email:</strong> {{ profile.emailAddress }}</p>
            <p><strong>Telefono:</strong> {{ profile.phone }}</p>
          </div>

          <!-- TAB 2: Indirizzi -->
          <div class="tab-pane fade" id="tab-address" role="tabpanel">
            <h3>Indirizzi</h3>

            <ul *ngIf="profile.addresses.length > 0; else noAddresses">
              <li *ngFor="let a of profile.addresses">
                <strong>{{ a.addressLine1 }}</strong
                >, {{ a.city }} - {{ a.postalCode }}
              </li>
            </ul>

            <ng-template #noAddresses>
              <p>Nessun indirizzo registrato.</p>
            </ng-template>
          </div>

          <!-- TAB 3: Ordini -->
          <div class="tab-pane fade" id="tab-orders" role="tabpanel">
            <h3>Storico Ordini</h3>

            <table *ngIf="profile.orders.length > 0; else noOrders" class="table table-bordered">
              <thead>
                <tr>
                  <th>Numero Ordine</th>
                  <th>Data</th>
                  <th>Totale</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- <tr *ngFor="let o of profile.orders">
                  <td>{{ o.salesOrderNumber }}</td>
                  <td>{{ o.orderDate | date : 'dd/MM/yyyy' }}</td>
                  <td>{{ o.totalDue | currency : 'EUR' }}</td>
                  <td>{{ o.status }}</td> -->
                <!-- <td>
                    <a [routerLink]="['/orders', o.salesOrderId]">
                      {{ o.salesOrderId }} Dettagli
                    </a>
                  </td> 
                </tr> -->
                <ng-container *ngFor="let o of profile.orders">
                  <!-- Riga ordine -->
                  <tr (click)="toggleOrder(o.salesOrderId)" style="cursor: pointer">
                    <td>{{ o.salesOrderNumber }}</td>
                    <td>{{ o.orderDate | date : 'dd/MM/yyyy' }}</td>
                    <td>{{ o.totalDue | currency : 'EUR' }}</td>
                    <td>{{ o.status }}</td>
                  </tr>

                  <!-- Riga dettaglio ordine espanso -->
                  <tr *ngIf="expandedOrderId === o.salesOrderId">
                    <td colspan="4">
                      <div *ngIf="orderDetails[o.salesOrderId]; else loadingDetail">
                        <p>
                          <strong>Metodo spedizione:</strong>
                          {{ orderDetails[o.salesOrderId].shipMethod }}
                        </p>
                        <p><strong>Totale:</strong> {{ orderDetails[o.salesOrderId].totalDue }}</p>

                        <h5>Articoli:</h5>
                        <ul>
                          <li *ngFor="let item of orderDetails[o.salesOrderId].items">
                            {{ item.productName }} - Qty: {{ item.orderQty }} - Totale:
                            {{ item.lineTotal }}
                          </li>
                        </ul>
                      </div>

                      <ng-template #loadingDetail>
                        <p>Caricamento dettagli...</p>
                      </ng-template>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>

            <ng-template #noOrders>
              <p>Nessun ordine effettuato.</p>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #noProfile>
    <p>Profilo non trovato.</p>
  </ng-template>
</div>

<!-- Loading -->
<ng-template #loadingTemplate>
  <div class="d-flex justify-content-center align-items-center" style="height: 200px">
    <div>Caricamento...</div>
  </div>
</ng-template>
